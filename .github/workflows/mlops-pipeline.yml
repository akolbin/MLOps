name: MLOps Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      alert_email:
        description: 'Email for alerts (optional)'
        required: false
        type: string
      skip_infrastructure:
        description: 'Skip infrastructure deployment (use existing)'
        required: false
        type: boolean
        default: false

env:
  TF_VERSION: '1.5.0'
  AWS_REGION: 'us-east-1'
  PYTHON_VERSION: '3.9'

jobs:
  # Step 1: Deploy Base Infrastructure (S3, IAM, Monitoring)
  base-infrastructure:
    name: Deploy Base Infrastructure
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read
      id-token: write
      pull-requests: write  # For PR comments
    outputs:
      s3_bucket_name: ${{ steps.tf-outputs.outputs.s3_bucket_name }}
      sagemaker_role_arn: ${{ steps.tf-outputs.outputs.sagemaker_role_arn }}
      infrastructure_changed: ${{ steps.tf-plan.outputs.exitcode == '2' }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4.3.1
      with:
        role-to-assume: arn:aws:iam::836072596305:role/GitHub_Actions_Runner
        aws-region: ${{ env.AWS_REGION }}

    - name: Terraform Init
      run: terraform init
      working-directory: ./terraform

    - name: Terraform Validate
      run: terraform validate
      working-directory: ./terraform

    - name: Terraform Plan
      id: tf-plan
      run: |
        export exitcode=0
        terraform plan \
          -var="alert_email=${{ github.event.inputs.alert_email || '' }}" \
          -detailed-exitcode \
          -no-color \
          -out tfplan || export exitcode=$?

        echo "exitcode=$exitcode" >> $GITHUB_OUTPUT
        
        if [ $exitcode -eq 1 ]; then
          echo "âŒ Terraform Plan Failed!"
          exit 1
        elif [ $exitcode -eq 2 ]; then
          echo "ğŸ“‹ Infrastructure changes detected"
        else
          echo "âœ… No infrastructure changes needed"
        fi
      working-directory: ./terraform

    - name: Comment PR with Plan
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const plan = fs.readFileSync('terraform/tfplan', 'utf8');
          const output = `## ğŸ—ï¸ Terraform Plan
          
          <details><summary>Click to expand plan output</summary>
          
          \`\`\`terraform
          ${plan}
          \`\`\`
          
          </details>`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          });

    - name: Terraform Apply Base Infrastructure
      if: github.ref == 'refs/heads/main' && (steps.tf-plan.outputs.exitcode == '2' || github.event.inputs.skip_infrastructure != 'true')
      run: |
        if [ "${{ steps.tf-plan.outputs.exitcode }}" == "2" ]; then
          echo "ğŸš€ Applying base infrastructure changes..."
          terraform apply -auto-approve tfplan
        else
          echo "â„¹ï¸ No changes to apply, but ensuring outputs are available..."
        fi
      working-directory: ./terraform

    - name: Get Base Infrastructure Outputs
      id: tf-outputs
      run: |
        echo "s3_bucket_name=$(terraform output -raw s3_bucket_name)" >> $GITHUB_OUTPUT
        echo "sagemaker_role_arn=$(terraform output -raw sagemaker_execution_role_arn)" >> $GITHUB_OUTPUT
      working-directory: ./terraform

  # Step 2: Generate Data and Train Model
  train-model:
    name: Train Model
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read
      id-token: write
    needs: [base-infrastructure]
    if: github.ref == 'refs/heads/main'
    outputs:
      model_trained: ${{ steps.train.outputs.success }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4.3.1
      with:
        role-to-assume: arn:aws:iam::836072596305:role/GitHub_Actions_Runner
        aws-region: ${{ env.AWS_REGION }}

    - name: Generate Training Data
      run: |
        echo "ğŸ“Š Generating training data..."
        python src/data/generate_data.py
      env:
        S3_BUCKET_NAME: ${{ needs.base-infrastructure.outputs.s3_bucket_name }}

    - name: Train Model
      id: train
      run: |
        echo "ğŸ¤– Training model..."
        python src/models/train.py
        echo "success=true" >> $GITHUB_OUTPUT
      env:
        S3_BUCKET_NAME: ${{ needs.base-infrastructure.outputs.s3_bucket_name }}
        SAGEMAKER_ROLE_ARN: ${{ needs.base-infrastructure.outputs.sagemaker_role_arn }}

  # Step 3: Deploy SageMaker Endpoint
  deploy-endpoint:
    name: Deploy SageMaker Endpoint
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read
      id-token: write
    needs: [base-infrastructure, train-model]
    if: github.ref == 'refs/heads/main' && needs.train-model.outputs.model_trained == 'true'
    outputs:
      endpoint_name: ${{ steps.deploy.outputs.endpoint_name }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4.3.1
      with:
        role-to-assume: arn:aws:iam::836072596305:role/GitHub_Actions_Runner
        aws-region: ${{ env.AWS_REGION }}

    - name: Deploy SageMaker Endpoint
      id: deploy
      run: |
        echo "ğŸš€ Deploying SageMaker endpoint..."
        python src/inference/deploy.py
        echo "endpoint_name=mlops-endpoint" >> $GITHUB_OUTPUT
      env:
        S3_BUCKET_NAME: ${{ needs.base-infrastructure.outputs.s3_bucket_name }}
        SAGEMAKER_ROLE_ARN: ${{ needs.base-infrastructure.outputs.sagemaker_role_arn }}

  # Step 4: Test Model Endpoint
  test-endpoint:
    name: Test Model Endpoint
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read
      id-token: write
    needs: [base-infrastructure, deploy-endpoint]
    if: github.ref == 'refs/heads/main' && needs.deploy-endpoint.outputs.endpoint_name != ''
    outputs:
      endpoint_ready: ${{ steps.test.outputs.success }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4.3.1
      with:
        role-to-assume: arn:aws:iam::836072596305:role/GitHub_Actions_Runner
        aws-region: ${{ env.AWS_REGION }}

    - name: Wait for Endpoint Ready
      run: |
        echo "â³ Waiting for SageMaker endpoint to be ready..."
        python -c "
        import boto3
        import time
        
        client = boto3.client('sagemaker')
        endpoint_name = '${{ needs.deploy-endpoint.outputs.endpoint_name }}'
        
        print(f'Waiting for endpoint {endpoint_name} to be ready...')
        
        for i in range(30):  # Wait up to 15 minutes
            try:
                response = client.describe_endpoint(EndpointName=endpoint_name)
                status = response['EndpointStatus']
                print(f'Endpoint status: {status}')
                
                if status == 'InService':
                    print('âœ… Endpoint is ready!')
                    break
                elif status == 'Failed':
                    raise Exception(f'âŒ Endpoint failed: {response.get(\"FailureReason\", \"Unknown\")}')
                    
                time.sleep(30)
            except client.exceptions.ClientError as e:
                if 'does not exist' in str(e):
                    print('â³ Endpoint not found yet, waiting...')
                    time.sleep(30)
                else:
                    raise e
        else:
            raise Exception('â° Timeout waiting for endpoint')
        "

    - name: Test Endpoint
      id: test
      run: |
        echo "ğŸ§ª Testing model endpoint..."
        python src/test_endpoint.py
        echo "success=true" >> $GITHUB_OUTPUT

  # Step 5: MLOps Monitoring and Health Check
  monitoring:
    name: MLOps Monitoring
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read
      id-token: write
    needs: [base-infrastructure, deploy-endpoint, test-endpoint]
    if: always() && needs.test-endpoint.outputs.endpoint_ready == 'true'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4.3.1
      with:
        role-to-assume: arn:aws:iam::836072596305:role/GitHub_Actions_Runner
        aws-region: ${{ env.AWS_REGION }}

    - name: Run MLOps Monitoring
      run: |
        echo "ğŸ“Š Running MLOps monitoring analysis..."
        python src/monitoring/mlops_monitor.py
      env:
        S3_BUCKET_NAME: ${{ needs.base-infrastructure.outputs.s3_bucket_name }}
        SAGEMAKER_ENDPOINT_NAME: ${{ needs.deploy-endpoint.outputs.endpoint_name }}

  # Final Summary
  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [base-infrastructure, train-model, deploy-endpoint, test-endpoint, monitoring]
    if: always()
    
    steps:
    - name: Create Pipeline Summary
      run: |
        echo "# ğŸš€ MLOps Pipeline Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Base Infrastructure
        if [ "${{ needs.base-infrastructure.result }}" == "success" ]; then
          echo "## âœ… Base Infrastructure" >> $GITHUB_STEP_SUMMARY
          echo "- **S3 Bucket**: \`${{ needs.base-infrastructure.outputs.s3_bucket_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **IAM Role**: Ready for SageMaker" >> $GITHUB_STEP_SUMMARY
        else
          echo "## âŒ Base Infrastructure Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Endpoint Deployment
        if [ "${{ needs.deploy-endpoint.result }}" == "success" ]; then
          echo "## âœ… Endpoint Deployment" >> $GITHUB_STEP_SUMMARY
          echo "- **Endpoint**: \`${{ needs.deploy-endpoint.outputs.endpoint_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- SageMaker endpoint created successfully" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.deploy-endpoint.result }}" == "skipped" ]; then
          echo "## â­ï¸ Endpoint Deployment Skipped" >> $GITHUB_STEP_SUMMARY
        else
          echo "## âŒ Endpoint Deployment Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Model Training
        if [ "${{ needs.train-model.result }}" == "success" ]; then
          echo "## âœ… Model Training" >> $GITHUB_STEP_SUMMARY
          echo "- Data generated and uploaded to S3" >> $GITHUB_STEP_SUMMARY
          echo "- Model trained and artifacts saved" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.train-model.result }}" == "skipped" ]; then
          echo "## â­ï¸ Model Training Skipped" >> $GITHUB_STEP_SUMMARY
          echo "- Only runs on main branch pushes" >> $GITHUB_STEP_SUMMARY
        else
          echo "## âŒ Model Training Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Endpoint Testing
        if [ "${{ needs.test-endpoint.result }}" == "success" ]; then
          echo "## âœ… Endpoint Testing" >> $GITHUB_STEP_SUMMARY
          echo "- Endpoint is ready and responding" >> $GITHUB_STEP_SUMMARY
          echo "- Model inference working correctly" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.test-endpoint.result }}" == "skipped" ]; then
          echo "## â­ï¸ Endpoint Testing Skipped" >> $GITHUB_STEP_SUMMARY
        else
          echo "## âŒ Endpoint Testing Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Monitoring
        if [ "${{ needs.monitoring.result }}" == "success" ]; then
          echo "## âœ… MLOps Monitoring" >> $GITHUB_STEP_SUMMARY
          echo "- Health check completed" >> $GITHUB_STEP_SUMMARY
          echo "- Performance metrics collected" >> $GITHUB_STEP_SUMMARY
          echo "- Monitoring reports saved to S3" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.monitoring.result }}" == "skipped" ]; then
          echo "## â­ï¸ Monitoring Skipped" >> $GITHUB_STEP_SUMMARY
        else
          echo "## âŒ Monitoring Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ¯ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "- Monitor model performance via CloudWatch dashboard" >> $GITHUB_STEP_SUMMARY
        echo "- Check data capture files in S3 for drift analysis" >> $GITHUB_STEP_SUMMARY
        echo "- Review monitoring reports for insights" >> $GITHUB_STEP_SUMMARY